YUI.add("controller",function(g){var e=g.Array,b=g.QueryString,c=g.HistoryBase.html5&&(!g.UA.android||g.UA.android>=3),a=g.config.win.location,d="ready";function f(){f.superclass.constructor.apply(this,arguments);}g.Controller=g.extend(f,g.Base,{base:"",routes:[],_regexPathParam:/([:*])([\w\d-]+)/g,_regexUrlQuery:/\?([^#]*).*$/,initializer:function(i){var h=this;i||(i={});h._routes=[];i.base&&(h.base=i.base);i.routes&&(h.routes=i.routes);if(g.Lang.isValue(i.dispatchOnInit)){h.dispatchOnInit=i.dispatchOnInit;}e.each(h.routes,function(j){h.route(j.path,j.callback,true);});h._history=c?new g.HistoryHTML5({force:true}):new g.HistoryHash();h._history.after("change",h._afterHistoryChange,h);h.publish(d,{defaultFn:h._defReadyFn,fireOnce:true});h.once("initializedChange",function(){setTimeout(function(){h.fire(d,{dispatched:!!h._dispatched});},20);});},destructor:function(){this._history.detachAll();},match:function(h){return e.filter(this._routes,function(i){return h.search(i.regex)>-1;});},replace:function(h,i,j){return this._save(h,i,j,true);},route:function(i,j){var h=[];this._routes.push({callback:j,keys:h,path:i,regex:this._getRegex(i,h)});return this;},save:function(h,i,j){return this._save(h,i,j);},_decode:function(h){return decodeURIComponent(h.replace(/\+/g," "));},_dispatch:function(n,m){var h=this.match(n),l,j,i;this._dispatched=true;if(!h||!h.length){return;}l=this._getRequest(n,m);i=this;function k(o){var q,p;if(o){g.error(o);}else{if((j=h.shift())){p=j.regex.exec(n);q=typeof j.callback==="string"?i[j.callback]:j.callback;if(p.length===j.keys.length+1){l.params=e.hash(j.keys,p.slice(1));}else{l.params={};e.each(p,function(s,r){l.params[r]=s;});}q.call(i,l,k);}}}k();},_getPath:(function(){var h=this;function i(k){var j=h.base;if(j&&k.indexOf(j)===0){k=k.substring(j.length);}return k;}return c?function(){return i(a.pathname);}:function(){return this._history.get("path")||i(a.pathname);};}()),_getQuery:c?function(){return a.search.substring(1);}:function(){return this._history.get("query")||a.search.substring(1);},_getRegex:function(i,h){if(i instanceof RegExp){return i;}i=i.replace(this._regexPathParam,function(k,j,l){h.push(l);return j==="*"?"(.*?)":"([^/]*)";});return new RegExp("^"+i+"$");},_getRequest:function(i,h){return{path:i,query:this._parseQuery(this._getQuery()),state:h};},_getState:c?function(){return this._history.get();}:function(){var h=this._history.get("state");return h?g.JSON.parse(h):{};},_parseQuery:b&&b.parse?b.parse:function(l){var m=this._decode,o=l.split("&"),k=0,j=o.length,h={},n;for(;k<j;++k){n=o[k].split("=");if(n[0]){h[m(n[0])]=m(n[1]||"");}}return h;},_save:function(h,l,m,j){var i,k;if(c){if(typeof h==="string"){h=this.base+h;}}else{i=l&&g.JSON.stringify(l);h=h.replace(this._regexUrlQuery,function(n,o){k=o;return"";});l={path:h||this._getPath()};k&&(l.query=k);i&&(l.state=i);}this._history[j?"replace":"add"](l||{},{merge:false,title:m,url:h});return this;},_afterHistoryChange:function(i){var h=this;setTimeout(function(){h._dispatch(h._getPath(),h._getState());},1);},_defReadyFn:function(h){if(this.dispatchOnInit&&!h.dispatched){this._dispatch(this._getPath(),this._getState());}}},{NAME:"controller"});},"@VERSION@",{optional:["querystring-parse"],requires:["array-extras","base-build","history","json"]});